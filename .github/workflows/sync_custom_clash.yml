name: Sync and Modify Custom_Clash_Mainland.ini

on:
  schedule:
    - cron: "0 */8 * * *" # 每隔8小时触发一次
  workflow_dispatch: # 添加手动触发事件

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    steps:
      # Step 1: 检出源仓库
      - name: Checkout Source Repo
        uses: actions/checkout@v3

      # Step 2: 克隆目标仓库
      - name: Clone Target Repo
        run: |
          git clone https://github.com/Aethersailor/Custom_OpenClash_Rules.git upstream-repo
          cd upstream-repo

      # Step 3: 修改文件
      - name: Modify File
        run: |
          # 复制原文件
          cp ./upstream-repo/cfg/Custom_Clash_Mainland.ini ./cfg/Custom_Clash_Mainland.ini

          # 在 Twitter 组后面添加EHentai组
          awk '
          /Twitter/ { last_match = NR }
          END {
              for (i = 1; i <= NR; i++) {
                  if (i == last_match + 1) {
                      print "custom_proxy_group=🔞 EHGallery`select`[]🇭🇰 香港节点`[]🇺🇸 美国节点`[]🇯🇵 日本节点`[]🇸🇬 新加坡节点`[]🇹🇼 台湾节点`[]🇰🇷 韩国节点`[]🇨🇦 加拿大节点`[]🇬🇧 英国节点`[]🇫🇷 法国节点`[]🇩🇪 德国节点`[]🇳🇱 荷兰节点`[]🇹🇷 土耳其节点`[]🇻🇳 越南节点`[]🚀 节点选择`[]♻️ 自动选择`[]🎯 全球直连`[]🇺🇳 原生IP"
                  }
                  print lines[i]
              }
          }
          { lines[NR] = $0 }
          ' ./cfg/Custom_Clash_Mainland.ini > temp.txt && mv temp.txt ./cfg/Custom_Clash_Mainland.ini

          # 在最后一行"custom_proxy_group"之后添加原生IP节点组
          awk '
          /custom_proxy_group/ { last_match = NR }
          END {
              for (i = 1; i <= NR; i++) {
                  if (i == last_match + 1) {
                      print "custom_proxy_group=🇺🇳 原生IP`url-test`(原生|家宽IEPL)`https://cp.cloudflare.com/generate_204`300,,50"
                  }
                  print lines[i]
              }
          }
          { lines[NR] = $0 }
          ' ./cfg/Custom_Clash_Mainland.ini > temp.txt && mv temp.txt ./cfg/Custom_Clash_Mainland.ini

          # 添加特定的规则集
          sed '0,/Twitter/{/Twitter/a\ruleset=🔞 EHentai,[]GEOSITE,ehgallery
          }' ./cfg/Custom_Clash_Mainland.ini -i
          sed '0,/Twitter/{/Twitter/a\ruleset=🇺🇳 原生IP,https://gh-proxy.com/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/EHGallery/EHGallery.list,28800
          }' ./cfg/Custom_Clash_Mainland.ini -i

      - name: Delete upstream-repo
        run: rm -rf upstream-repo

      # Step 4: 提交更改到目标仓库
      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cfg/Custom_Clash_Mainland.ini
          git commit -m "Update Custom_Clash_Mainland.ini based on https://github.com/Aethersailor/Custom_Clash_Rules/Custom_Clash_Mainland.ini"
          git push origin HEAD
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
