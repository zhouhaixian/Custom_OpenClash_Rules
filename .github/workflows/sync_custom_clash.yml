name: Sync and Modify Custom_Clash_Mainland.ini

on:
  schedule:
    - cron: "0 */8 * * *" # æ¯éš”8å°æ—¶è§¦å‘ä¸€æ¬¡
  workflow_dispatch: # æ·»åŠ æ‰‹åŠ¨è§¦å‘äº‹ä»¶

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    steps:
      # Step 1: æ£€å‡ºæºä»“åº“
      - name: Checkout Source Repo
        uses: actions/checkout@v3

      # Step 2: å…‹éš†ç›®æ ‡ä»“åº“
      - name: Clone Target Repo
        run: |
          git clone https://github.com/Aethersailor/Custom_OpenClash_Rules.git upstream-repo
          cd upstream-repo

      # Step 3: ä¿®æ”¹æ–‡ä»¶
      - name: Modify File
        run: |
          # å¤åˆ¶åŸæ–‡ä»¶
          cp ./upstream-repo/cfg/Custom_Clash_Mainland.ini ./cfg/Custom_Clash_Mainland.ini

          # åœ¨ Twitter ç»„åé¢æ·»åŠ EHentaiç»„
          awk '
          /Twitter/ { last_match = NR }
          END {
              for (i = 1; i <= NR; i++) {
                  if (i == last_match + 1) {
                      print "custom_proxy_group=ğŸ” EHGallery`select`[]ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹`[]ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹`[]ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹`[]ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹`[]ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹`[]ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹`[]ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§èŠ‚ç‚¹`[]ğŸ‡¬ğŸ‡§ è‹±å›½èŠ‚ç‚¹`[]ğŸ‡«ğŸ‡· æ³•å›½èŠ‚ç‚¹`[]ğŸ‡©ğŸ‡ª å¾·å›½èŠ‚ç‚¹`[]ğŸ‡³ğŸ‡± è·å…°èŠ‚ç‚¹`[]ğŸ‡¹ğŸ‡· åœŸè€³å…¶èŠ‚ç‚¹`[]ğŸ‡»ğŸ‡³ è¶Šå—èŠ‚ç‚¹`[]ğŸš€ èŠ‚ç‚¹é€‰æ‹©`[]â™»ï¸ è‡ªåŠ¨é€‰æ‹©`[]ğŸ¯ å…¨çƒç›´è¿`[]ğŸ‡ºğŸ‡³ åŸç”ŸIP"
                  }
                  print lines[i]
              }
          }
          { lines[NR] = $0 }
          ' ./cfg/Custom_Clash_Mainland.ini > temp.txt && mv temp.txt ./cfg/Custom_Clash_Mainland.ini

          # åœ¨æœ€åä¸€è¡Œ"custom_proxy_group"ä¹‹åæ·»åŠ åŸç”ŸIPèŠ‚ç‚¹ç»„
          awk '
          /custom_proxy_group/ { last_match = NR }
          END {
              for (i = 1; i <= NR; i++) {
                  if (i == last_match + 1) {
                      print "custom_proxy_group=ğŸ‡ºğŸ‡³ åŸç”ŸIP`url-test`(åŸç”Ÿ|å®¶å®½IEPL)`https://cp.cloudflare.com/generate_204`300,,50"
                  }
                  print lines[i]
              }
          }
          { lines[NR] = $0 }
          ' ./cfg/Custom_Clash_Mainland.ini > temp.txt && mv temp.txt ./cfg/Custom_Clash_Mainland.ini

          # æ·»åŠ ç‰¹å®šçš„è§„åˆ™é›†
          sed '0,/Twitter/{/Twitter/a\ruleset=ğŸ” EHentai,[]GEOSITE,ehgallery
          }' ./cfg/Custom_Clash_Mainland.ini -i
          sed '0,/Twitter/{/Twitter/a\ruleset=ğŸ‡ºğŸ‡³ åŸç”ŸIP,https://gh-proxy.com/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/EHGallery/EHGallery.list,28800
          }' ./cfg/Custom_Clash_Mainland.ini -i

      - name: Delete upstream-repo
        run: rm -rf upstream-repo

      # Step 4: æäº¤æ›´æ”¹åˆ°ç›®æ ‡ä»“åº“
      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cfg/Custom_Clash_Mainland.ini
          git commit -m "Update Custom_Clash_Mainland.ini based on https://github.com/Aethersailor/Custom_Clash_Rules/Custom_Clash_Mainland.ini"
          git push origin HEAD
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
